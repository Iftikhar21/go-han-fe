@using go_han_fe.Models.DTOs
@using go_han_fe.Services.State
@inject NavigationManager Navigation
@inject AuthState AuthState
@implements IDisposable

@code {
    [Parameter] public bool _sidebarOpen { get; set; }
    [Parameter] public EventCallback<bool> _sidebarOpenChanged { get; set; }

    private bool _isDisposed = false;
    private List<MenuItem> _menuItems = new();
    private List<MenuItem> _adminMenuItems = new();
    private List<MenuItem> _employeeMenuItems = new();

    protected override void OnInitialized()
    {
        // Subscribe to auth state changes
        AuthState.OnChange += OnAuthStateChanged;

        // Initialize menu items
        InitializeMenuItems();

        // Mark as loaded if not authenticated (prevents hanging on loading screen)
        if (!AuthState.IsAuthenticated)
        {
            AuthState.MarkLoaded();
        }
    }

    private void InitializeMenuItems()
    {
        // Common menu items for all users
        _menuItems = new List<MenuItem>
{
new MenuItem
{
Id = 1,
Title = "Dashboard",
Icon = "bi-house",
Href = "/dashboard",
IsVisible = AuthState.IsAuthenticated
},
new MenuItem
{
Id = 2,
Title = "Profile",
Icon = "bi-person",
Href = "/profile",
IsVisible = AuthState.IsAuthenticated
}
};
        _adminMenuItems = new List<MenuItem>
{
// User Management
new MenuItem
{
Id = 10,
Title = "User Management",
Icon = "",
Href = "#",
IsGroup = true,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 11,
Title = "Users",
Icon = "bi-people",
Href = "/admin/users",
ParentId = 10,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 12,
Title = "Roles",
Icon = "bi-person-badge",
Href = "/admin/roles",
ParentId = 10,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 13,
Title = "Divisions",
Icon = "bi-diagram-3",
Href = "/admin/divisions",
ParentId = 10,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 20,
Title = "Projects",
Icon = "",
Href = "#",
IsGroup = true,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 21,
Title = "Projects",
Icon = "bi-folder",
Href = "/admin/projects",
ParentId = 20,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 22,
Title = "Project Members",
Icon = "bi-people-fill",
Href = "/admin/project-members",
ParentId = 20,
IsVisible = AuthState.IsAdmin()
},

// Reports
new MenuItem
{
Id = 30,
Title = "Reports",
Icon = "",
Href = "#",
IsGroup = true,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 31,
Title = "Project Overview",
Icon = "bi-bar-chart",
Href = "/admin/reports/project-overview",
ParentId = 30,
IsVisible = AuthState.IsAdmin()
},
new MenuItem
{
Id = 32,
Title = "Task Overview",
Icon = "bi-bar-chart-line",
Href = "/admin/reports/task-overview",
ParentId = 30,
IsVisible = AuthState.IsAdmin()
},

// Settings
new MenuItem
{
Id = 40,
Title = "Settings",
Icon = "bi-gear",
Href = "/admin/settings",
IsVisible = AuthState.IsAdmin()
}
};

        _employeeMenuItems = new List<MenuItem>
{
new MenuItem
{
Id = 50,
Title = "My Projects",
Icon = "bi-folder",
Href = "/employee/my-projects",
IsVisible = AuthState.IsEmployee()
},
new MenuItem
{
Id = 51,
Title = "My Tasks",
Icon = "bi-list-task",
Href = "/employee/my-tasks",
IsVisible = AuthState.IsEmployee()
},
new MenuItem
{
Id = 52,
Title = "Task Board",
Icon = "bi-kanban",
Href = "/employee/task-board",
IsVisible = AuthState.IsEmployee()
},
new MenuItem
{
Id = 53,
Title = "Reports",
Icon = "bi-bar-chart",
Href = "/employee/reports",
IsVisible = AuthState.IsEmployee()
}
};
    }

    private async void OnAuthStateChanged()
    {
        // Update menu items when auth state changes
        InitializeMenuItems();
        await InvokeAsync(StateHasChanged);
    }

    private string GetGradientStyle()
    {
        return AuthState.IsAdmin()
        ? "background: linear-gradient(to bottom, #004AAD, #003A8C)"
        : "background: linear-gradient(to bottom, #2E7D32, #1B5E20)";
    }

    private string GetPanelTitle()
    {
        return AuthState.IsAdmin() ? "Admin Panel" : "Employee Portal";
    }

    private async Task HandleLogout()
    {
        Console.WriteLine("=== LOGOUT INITIATED ===");

        AuthState.Logout();

        await Task.Delay(100);

        Navigation.NavigateTo("/login", forceLoad: true);
    }

    private List<MenuItem> GetItemsByParentId(int? parentId)
    {
        if (AuthState.IsAdmin())
            return _adminMenuItems.Where(item => item.ParentId == parentId).ToList();
        else if (AuthState.IsEmployee())
            return _employeeMenuItems.Where(item => item.ParentId == parentId).ToList();

        return new List<MenuItem>();
    }

    private bool HasChildren(int id)
    {
        if (AuthState.IsAdmin())
            return _adminMenuItems.Any(item => item.ParentId == id);

        return false;
    }

    private string GetSidebarClasses()
    {
        var baseClasses = "fixed top-0 left-0 h-screen w-80 bg-gradient-to-b z-40 transform transition-transform duration-300 flex flex-col border-r border-white/10 shadow-2xl";

        if (_sidebarOpen)
            return $"{baseClasses} translate-x-0";
        else
            return $"{baseClasses} -translate-x-full lg:translate-x-0";
    }
    public void Dispose()
    {
        if (!_isDisposed)
        {
            Console.WriteLine("=== SIDEBAR DISPOSED ===");
            AuthState.OnChange -= OnAuthStateChanged;
            _isDisposed = true;
        }
    }
}

@if (!AuthState.IsLoaded)
{
    <div class="p-4 text-white/70 text-sm">
        Loading menu...
    </div>
}
else
{
    <div class="@GetSidebarClasses()" style="@GetGradientStyle()">
        <div class="p-6 border-b border-white/10 flex-shrink-0 bg-white/5 backdrop-blur-md">
            <div class="w-40 h-40 mx-auto flex flex-col items-center justify-center">
                <img src="images/gohan_logo.svg" alt="Logo" class="rounded-xl w-full h-auto" />
            </div>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col">
            <nav class="p-4 flex-1 overflow-y-auto">
                <ul class="space-y-2">
                    @foreach (var item in _menuItems.Where(m => m.IsVisible))
                    {
                        <li>
                            <NavLink href="@item.Href"
                                class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300 text-white/80 hover:text-white hover:bg-white/10"
                                active-class="bg-white/20 text-white shadow-lg border-r-4 border-white">
                                @if (!string.IsNullOrEmpty(item.Icon))
                                {
                                    <i class="bi @item.Icon w-5 h-5"></i>
                                }
                                <span class="font-medium text-sm">@item.Title</span>
                            </NavLink>
                        </li>
                    }

                    @if (AuthState.IsAdmin())
                    {
                        @foreach (var group in _adminMenuItems.Where(m => m.IsGroup && m.IsVisible))
                        {
                            <li>
                                <span class="font-medium text-sm text-white/80 px-4 py-2 mt-4 block">@group.Title</span>
                                <ul class="pl-6 space-y-1">
                                    @foreach (var subItem in _adminMenuItems.Where(m => m.ParentId == group.Id && m.IsVisible))
                                    {
                                        <li>
                                            <NavLink href="@subItem.Href"
                                                class="flex items-center gap-3 px-4 py-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10"
                                                active-class="bg-white/20 text-white shadow-lg border-r-4 border-white">
                                                @if (!string.IsNullOrEmpty(subItem.Icon))
                                                {
                                                    <i class="bi @subItem.Icon w-4 h-4"></i>
                                                }
                                                @subItem.Title
                                            </NavLink>
                                        </li>
                                    }
                                </ul>
                            </li>
                        }

                        @foreach (var item in _adminMenuItems.Where(m => !m.IsGroup && !m.ParentId.HasValue && m.IsVisible))
                        {
                            <li>
                                <NavLink href="@item.Href"
                                    class="flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-300 hover:bg-white/10 text-white/80 hover:text-white"
                                    active-class="bg-white/20 text-white shadow-lg border-r-4 border-white">
                                    @if (!string.IsNullOrEmpty(item.Icon))
                                    {
                                        <i class="bi @item.Icon w-5 h-5"></i>
                                    }
                                    <span class="font-medium text-sm">@item.Title</span>
                                </NavLink>
                            </li>
                        }
                    }

                    @if (AuthState.IsEmployee())
                    {
                        @foreach (var item in _employeeMenuItems.Where(m => m.IsVisible))
                        {
                            <li>
                                <NavLink href="@item.Href"
                                    class="flex items-center gap-3 px-4 py-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10"
                                    active-class="bg-white/20 text-white shadow-lg border-r-4 border-white">
                                    @if (!string.IsNullOrEmpty(item.Icon))
                                    {
                                        <i class="bi @item.Icon w-4 h-4"></i>
                                    }
                                    @item.Title
                                </NavLink>
                            </li>
                        }
                    }

                    <li class="mt-4">
                        <button @onclick="HandleLogout"
                            class="flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors duration-200">
                            <i class="bi bi-box-arrow-right w-4 h-4"></i>
                            <span class="text-sm font-medium">Logout</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
}

@code {
    public class MenuItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
        public string Href { get; set; } = string.Empty;
        public bool IsVisible { get; set; } = true;
        public bool IsGroup { get; set; } = false;
        public int? ParentId { get; set; }
    }
}